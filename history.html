<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>すべての実績履歴 - 空木/utugi HP</title>
    <link rel="icon" href="resources/images/utugi_icon_favicon.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <header class="bg-gray-900 text-white h-24 fixed top-0 left-0 right-0 z-50 shadow-md flex items-center justify-between px-4 sm:px-14">
        <div class="text-lg sm:text-xl font-bold">
            <a href="index.html">空木/utugi</a>
        </div>
        <nav class="hidden sm:block">
            <ul class="flex space-x-3 sm:space-x-4 text-sm sm:text-base">
                <li><a href="index.html#profile" class="hover:text-gray-300 px-2 py-1 rounded-md">About</a></li>
                <li><a href="index.html#gallery" class="hover:text-gray-300 px-2 py-1 rounded-md">Gallery</a></li>
                <li><a href="#top" class="hover:text-gray-300 px-2 py-1 rounded-md">Data</a></li>
                <li><a href="index.html#contact" class="hover:text-gray-300 px-2 py-1 rounded-md">Contact</a></li>
            </ul>
        </nav>
        <div class="sm:hidden">
            <button id="hamburger-button" class="text-white focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                </svg>
            </button>
        </div>
    </header>
    <!-- Mobile Menu - Initially hidden -->
    <nav id="mobile-menu-nav" class="mobile-menu">
        <a href="index.html#profile" class="mobile-menu-link">About</a>
        <a href="index.html#gallery" class="mobile-menu-link">Gallery</a>
        <a href="#top" class="mobile-menu-link">Data</a>
        <a href="index.html#contact" class="mobile-menu-link">Contact</a>
    </nav>

    <main class="pt-24 py-12 sm:py-20 px-4 sm:px-14">
        <div class="container mx-auto max-w-4xl">
            <div class="text-center mb-12 sm:mb-16">
                <span class="section-title-line mb-4 sm:mb-6"></span>
                <h2 class="text-3xl sm:text-4xl font-bold text-gray-800 section-main-title">
                    <span class="first-letter">W</span><span class="rest-of-title">orks</span>
                </h2>
                <p class="text-gray-600 text-base sm:text-lg mt-2">実績記録</p>
                <span class="section-title-line mt-4 sm:mt-6"></span>
                <!-- YouTubeプレイリストリンク -->
                <div class="mt-6">
                    <a href="https://www.youtube.com/playlist?list=PLbNq05L8kMQtjO3HJi5AIhOHNKyNDGAkP" target="_blank" rel="noopener noreferrer" class="inline-flex items-center text-red-600 hover:text-red-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="mr-2 h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                        </svg>
                        <span class="text-sm font-medium underline">携わった動画を見る (YouTubeプレイリスト)</span>
                    </a>
                </div>
            </div>

            <div class="data-area-block max-w-3xl mx-auto">
                <!-- フィルターセクション -->
                <div class="mb-8">
                    <!-- 並び替えと全選択ボタン -->
                    <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-300">
                        <button id="sort-toggle" class="text-sm text-gray-700 hover:text-gray-900 font-medium underline">
                            ▼ 新しい順
                        </button>
                        <button class="filter-all-button" data-category="all">すべて選択/解除</button>
                    </div>
                    <!-- カテゴリータグ -->
                    <div class="flex flex-wrap gap-2 justify-center mb-2">
                        <button class="filter-tag" data-category="オリジナル楽曲MV制作">オリジナル楽曲MV</button>
                        <button class="filter-tag" data-category="歌ってみたMV制作">歌ってみたMV</button>
                        <button class="filter-tag" data-category="ショートムービー制作">ショートムービー</button>
                        <button class="filter-tag" data-category="その他">その他</button>
                    </div>
                    <div class="text-center text-sm text-gray-600">
                        <p>クリックで複数選択可能</p>
                    </div>
                </div>

                <div id="full-history-list-container" class="space-y-2">
                    <!-- CSVから読み込まれたすべての履歴データがここに表示されます -->
                </div>
                <div class="text-center mt-8">
                    <a href="index.html#data" class="back-button">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                        </svg>
                        トップページに戻る
                    </a>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-900 text-gray-400 py-8 text-center">
        <div class="footer-sns-icons flex justify-center space-x-4 mb-4">
            <a href="https://x.com/utugi313" target="_blank" rel="noopener noreferrer" aria-label="X (旧Twitter)へのリンク">
                <img src="resources/images/X_icon.png" alt="X icon" onerror="this.style.display='none'">
            </a>
            <a href="https://www.youtube.com/@utugi2421" target="_blank" rel="noopener noreferrer" aria-label="YouTubeへのリンク">
                <img src="resources/images/youtube_icon.png" alt="YouTube icon" onerror="this.style.display='none'">
            </a>
        </div>
        <p class="text-sm">© 2024 空木/utugi. All Rights Reserved.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // ハンバーガーメニューの切り替え
            const hamburgerButton = document.getElementById('hamburger-button');
            const mobileMenu = document.getElementById('mobile-menu-nav');
            const mobileMenuLinks = mobileMenu.querySelectorAll('.mobile-menu-link');

            if (hamburgerButton && mobileMenu) {
                hamburgerButton.addEventListener('click', function() {
                    mobileMenu.classList.toggle('active');
                });
                // リンクがクリックされたらメニューを閉じる
                mobileMenuLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        mobileMenu.classList.remove('active');
                    });
                });
            }

            const fullHistoryListContainer = document.getElementById('full-history-list-container');
            let allHistoryData = []; // 全データを保持
            const activeFilters = new Set(); // アクティブなフィルター
            let isDescending = true; // 降順フラグ
            const knownCategories = ['オリジナル楽曲MV制作', '歌ってみたMV制作', 'ショートムービー制作'];

            // 並び替えボタンのイベントリスナー
            const sortToggleButton = document.getElementById('sort-toggle');
            sortToggleButton.addEventListener('click', function() {
                isDescending = !isDescending;
                this.textContent = isDescending ? '▼ 新しい順' : '▲ 古い順';
                renderFullHistory(filterData(allHistoryData));
            });

            // フィルターボタンのイベントリスナー
            document.querySelectorAll('.filter-tag, .filter-all-button').forEach(button => {
                button.addEventListener('click', function() {
                    const category = this.dataset.category;
                    
                    if (category === 'all') {
                        // 「すべて選択/解除」ボタンの動作
                        const allButton = this;
                        const categoryButtons = document.querySelectorAll('.filter-tag');
                        
                        if (allButton.classList.contains('active')) {
                            // 全解除
                            activeFilters.clear();
                            allButton.classList.remove('active');
                            categoryButtons.forEach(btn => btn.classList.remove('active'));
                        } else {
                            // 全選択
                            activeFilters.clear();
                            categoryButtons.forEach(btn => {
                                const cat = btn.dataset.category;
                                activeFilters.add(cat);
                                btn.classList.add('active');
                            });
                            allButton.classList.add('active');
                        }
                    } else {
                        // 個別カテゴリーの選択
                        const allButton = document.querySelector('[data-category="all"]');
                        
                        if (activeFilters.has(category)) {
                            activeFilters.delete(category);
                            this.classList.remove('active');
                        } else {
                            activeFilters.add(category);
                            this.classList.add('active');
                        }
                        
                        // すべてのカテゴリーが選択されているかチェック
                        const categoryButtons = document.querySelectorAll('.filter-tag');
                        const allSelected = Array.from(categoryButtons).every(btn => btn.classList.contains('active'));
                        
                        if (allSelected) {
                            allButton.classList.add('active');
                        } else {
                            allButton.classList.remove('active');
                        }
                    }
                    
                    // フィルタリングして再描画
                    renderFullHistory(filterData(allHistoryData));
                });
            });

            // データをフィルタリングする関数
            function filterData(data) {
                if (activeFilters.size === 0) {
                    return data; // 何も選択されていない場合は全て表示
                }
                return data.filter(item => {
                    // 「その他」が選択されている場合、既知のカテゴリー以外も含める
                    if (activeFilters.has('その他') && !knownCategories.includes(item.type)) {
                        return true;
                    }
                    return activeFilters.has(item.type);
                });
            }

            // 履歴リストをレンダリングする関数 (全件表示用)
            function renderFullHistory(historyData) {
                if (!fullHistoryListContainer) return;
                fullHistoryListContainer.innerHTML = ''; // 既存の内容をクリア

                // ソート処理
                const sortedData = [...historyData].sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    return isDescending ? dateB - dateA : dateA - dateB;
                });

                // 年ごとにグループ化
                const groupedByYear = {};
                sortedData.forEach(item => {
                    const year = item.date.substring(0, 4); // 日付から年を取得
                    if (!groupedByYear[year]) {
                        groupedByYear[year] = [];
                    }
                    groupedByYear[year].push(item);
                });

                // 年をソート
                const years = Object.keys(groupedByYear).sort((a, b) => isDescending ? b - a : a - b);

                years.forEach((year, index) => {
                    // 年の見出しを追加
                    const yearHeading = document.createElement('h4');
                    // 最初の年以外には上に余白を追加
                    const marginTop = index === 0 ? 'mt-0' : 'mt-16';
                    yearHeading.className = `text-xl font-bold text-gray-700 ${marginTop} mb-4 pb-2 border-b-2 border-gray-300`;
                    yearHeading.textContent = `${year}年`;
                    yearHeading.style.paddingTop = index === 0 ? '0' : '3rem'; // 48px
                    fullHistoryListContainer.appendChild(yearHeading);

                    // その年の履歴アイテムを追加
                    groupedByYear[year].forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'history-item';

                        // リンクが存在する場合はaタグを、存在しない場合はpタグを生成
                        const titleElement = item.link
                            ? `<a href="${item.link}" target="_blank" rel="noopener noreferrer" class="title">${item.title}</a>`
                            : `<p class="title">${item.title}</p>`;

                        itemDiv.innerHTML = `
                            <div class="flex-grow">
                                ${titleElement}
                                <p class="artist">${item.artist}</p>
                            </div>
                            <div class="text-right">
                                <p class="date">${item.date}</p>
                                <p class="type">${item.type}</p>
                            </div>
                        `;
                        fullHistoryListContainer.appendChild(itemDiv);
                    });
                });
            }

            // CSVデータをパースし、履歴リストを更新する関数 (このページではチャートは不要)
            function parseCsvForHistory(csvText) {
                const lines = csvText.trim().split('\n');
                const dataRows = lines.slice(1); // ヘッダー行をスキップ
                const parsedData = [];

                dataRows.forEach(line => {
                    const values = line.split(',');
                    // 公開日 (values[2]) が存在し、空でないデータのみを使用
                    if (values.length >= 6 && values[2] && values[2].trim() !== '') {
                        parsedData.push({
                            client: values[0] ? values[0].trim() : '',
                            title: values[1] ? values[1].trim() : '',
                            releaseDate: values[2] ? values[2].trim() : '',
                            requestContent: values[3] ? values[3].trim() : '',
                            cgUsageCol4: values[4] ? values[4].trim() : '', // Column E (index 4)
                            link: values[5] ? values[5].trim() : '', // Column F (index 5)
                        });
                    }
                });

                // 履歴リスト用のデータを準備してソート (新しい日付が先頭に来るように)
                allHistoryData = parsedData.map(item => ({
                    artist: item.client,
                    title: item.title,
                    date: item.releaseDate,
                    type: item.requestContent,
                    link: item.link // linkプロパティを追加
                })).sort((a, b) => new Date(b.date) - new Date(a.date));

                renderFullHistory(allHistoryData); // 全件表示をレンダリング
            }

            // CSVデータをロードする関数
            async function loadCsvData() {
                try {
                    const response = await fetch('data/utugi_works.csv');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const csvText = await response.text();
                    parseCsvForHistory(csvText);
                } catch (error) {
                    console.error('CSVデータの読み込みまたはパース中にエラーが発生しました:', error);
                    // エラーメッセージをUIに表示
                    const mainContent = document.querySelector('main .container');
                    if (mainContent) {
                        const errorMessage = document.createElement('p');
                        errorMessage.className = 'text-center text-red-500 mt-4';
                        errorMessage.textContent = '実績データの表示に失敗しました。CSVファイルが正しく読み込まれているか確認してください。';
                        mainContent.appendChild(errorMessage);
                    }
                }
            }

            // ページロード時にCSVデータをロード
            loadCsvData();
        });
    </script>

</body>
</html>
